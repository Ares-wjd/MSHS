<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>책 추천</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f5f7fa;
      color: #333;
      padding: 40px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .btn {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #0056b3;
    }
    .hidden {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #eee;
    }
  </style>
</head>
<body>

  <h1>책 추천 시스템</h1>

  <!-- 1차 분류 -->
  <div id="level1" class="btn-group">
    <button class="btn" onclick="selectLevel(1, '일반')">일반</button>
    <button class="btn" onclick="selectLevel(1, '과목')">과목</button>
  </div>

  <!-- 2차 분류 -->
  <div id="level2" class="btn-group hidden"></div>

  <!-- 3차 분류 -->
  <div id="level3" class="btn-group hidden"></div>

  <!-- 4차 분류 -->
  <div id="level4" class="btn-group hidden"></div>


  <div id="controls" class="btn-group hidden">
    <button id="showResultsBtn" class="btn" onclick="showResults()">추천 도서 보기</button>
  </div>

  <div id="results" class="hidden"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const data = {
      "일반": {
        "문학": ["소설", "시집", "수필", "희곡"],
        "과학*기술": ["자연과학", "기술과학", "컴퓨터"],
        "사회과학": ["지리", "종교", "정치", "경제", "철학"],
        "역사": ["아시아", "유럽", "아프리카", "아메리카", "오세아니아, 양극지방"],
        "예체능": ["미술", "체육", "음악"]
      },
      "과목": {
        "국어": ["문학", "독서", "언어와 매체", "화법과 작문"],
        "수학": ["수학1", "수학2", "미적분", "기하", "확률과 통계"],
        "영어": [],
        "과학": ["물리", "화학", "생명과학", "지구과학"],
        "사회": ["윤리와 사상", "생활과 윤리", "한국지리", "세계지리", "동아시아사", "세계사", "정치와 법", "사회 문화", "경제"],
        "예체능": ["음악", "미술", "체육"],
        "기술가정": ["정보/인공지능"],
        "제2외국어": ["한문", "일본어"]
      }
    };

    const EXCEL_URL = "./dlsExportList_classified.xlsx";
    let bookData = [];
    let excelLoaded = false;

    async function loadExcel() {
      try {
        const res = await fetch(EXCEL_URL);
        if (!res.ok) throw new Error(res.statusText);
        const arrayBuffer = await res.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        bookData = XLSX.utils.sheet_to_json(sheet);
        excelLoaded = true;
      } catch (e) {
        console.error("엑셀 로드 실패", e);
        document.getElementById("results").innerHTML = "<p>데이터를 불러오지 못했습니다.</p>";
      }
    }
    loadExcel();

    let selected = {
      level1: "",
      level2: "",
      level3: "",
      level4: ""
    };

    function selectLevel(level, value) {
      if (level === 1) {
        selected.level1 = value;
        selected.level2 = "";
        selected.level3 = "";
        selected.level4 = "";
        showNext("level2", Object.keys(data[value]), 2);
        document.getElementById("controls").classList.add("hidden");
        document.getElementById("results").classList.add("hidden");
        document.getElementById("level3").classList.add("hidden");
        document.getElementById("level4").classList.add("hidden");
      } else if (level === 2) {
        selected.level2 = value;
        selected.level3 = "";
        selected.level4 = "";
        showNext("level3", data[selected.level1][value], 3);
        document.getElementById("controls").classList.remove("hidden");
        document.getElementById("results").classList.add("hidden");
        document.getElementById("level4").classList.add("hidden");
      } else if (level === 3) {
        selected.level3 = value;
        selected.level4 = "";
        if (excelLoaded) {
          const level4Options = Array.from(new Set(bookData
            .filter(r => r["1차분류"] === selected.level1 &&
                        r["2차분류"] === selected.level2 &&
                        r["3차분류"] === selected.level3)
            .map(r => r["4차분류"]) 
            .filter(v => v && v.trim())));
          if (level4Options.length > 0) {
            showNext("level4", level4Options, 4);
            document.getElementById("controls").classList.remove("hidden");
            document.getElementById("results").classList.add("hidden");
            return;
          }
        }
        showResults();
      } else if (level === 4) {
        selected.level4 = value;
        showResults();
      }
    }
    function showResults() {
      const resultsDiv = document.getElementById("results");
      if (!excelLoaded) {
        resultsDiv.innerHTML = "<p>데이터를 불러오는 중입니다. 잠시만 기다려주세요.</p>";
        resultsDiv.classList.remove("hidden");
        return;
      }
      const filtered = bookData.filter(row => {
        if (row["1차분류"] !== selected.level1) return false;
        if (selected.level2 && row["2차분류"] !== selected.level2) return false;
        if (selected.level3 && row["3차분류"] !== selected.level3) return false;
        if (selected.level4 && row["4차분류"] !== selected.level4) return false;
        return true;
      });
      if (filtered.length === 0) {
        resultsDiv.innerHTML = "<p>조건에 맞는 도서가 없습니다.</p>";
      } else {
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>자료명</th><th>저자</th><th>출판사</th><th>청구기호</th></tr>";
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        filtered.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row["자료명"]}</td><td>${row["저자"]}</td><td>${row["출판사"]}</td><td>${row["청구기호"]}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        resultsDiv.innerHTML = "";
        resultsDiv.appendChild(table);
      }
      resultsDiv.classList.remove("hidden");
    }

    function showNext(id, items, nextLevel) {
      const container = document.getElementById(id);
      container.innerHTML = "";
      if (items.length > 0) {
        items.forEach(item => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.innerText = item;
          btn.onclick = () => selectLevel(nextLevel, item);
          container.appendChild(btn);
        });
        container.classList.remove("hidden");
      } else {
        container.classList.add("hidden");
      }

      if (nextLevel <= 2) {
        document.getElementById("level3").classList.add("hidden");
        document.getElementById("level4").classList.add("hidden");
      } else if (nextLevel === 3) {
        document.getElementById("level4").classList.add("hidden");
      }
    }
  </script>

</body>
</html>
